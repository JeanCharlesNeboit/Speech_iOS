name: Build & Test

on:
  push:
    branches:
      - '**'
    paths:
      - '**.swift'
      - '**/build_test.yml'

env:
  GOOGLE_SERVICE_INFO_PLIST_PATH: "./Firebase/Crashlytics/GoogleService-Info.plist"
  DERIVED_DATA_PATH: "./DerivedData"
  BUILD_PRODUCTS_ARTIFACT_NAME: "build_products"

jobs:
  prepare:
    name: Prepare
    runs-on: macOS-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Set env from .github.env file
        uses: JeanCharlesNeboit/action-dotenv-to-setenv@main
        with:
          env-file: .github.env
  
  lint:
    name: Lint
    runs-on: macOS-latest
    needs: prepare
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Swiftlint
        run: swiftlint lint --reporter github-actions-logging
  
  build:
    name: Build
    runs-on: macOS-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          submodules: recursive
      - name: Xcode select
        uses: ./SwiftyCI/actions/xcode_select
      - name: Run build action
        id: build
        uses: ./SwiftyCI/actions/build
        with:
          scheme: ${{ env.SCHEME }}
          derivedDataPath: ${{ env.DERIVED_DATA_PATH }}
      - if: ${{ steps.build.outputs.exit_code != 0 }}
        name: Upload xcodebuild log
        uses: actions/upload-artifact@v2
        with:
          name: xcodebuild.log
          path: ./xcodebuild.log
      - if: ${{ steps.build.outputs.exit_code == 0 }}
        name: Upload build products
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.BUILD_PRODUCTS_ARTIFACT_NAME }}
          path: ${{ env.DERIVED_DATA_PATH }}/Build/Products
  
  test:
    name: Test
    runs-on: macOS-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          submodules: recursive
      - name: Xcode select
        uses: ./SwiftyCI/actions/xcode_select
      - name: Download products
        uses: actions/download-artifact@v2
        with:
          name: ${{ env.BUILD_PRODUCTS_ARTIFACT_NAME }}
      - name: Run test action
        uses: ./SwiftyCI/actions/test